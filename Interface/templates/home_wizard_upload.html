<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8">
    <title>GraphPlanLLM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet'>
    <link href="../static/Page/css/bootstrap.min.css" rel="stylesheet">
    <link href="../static/select/element.min.css" rel="stylesheet">
    <link href="../static/select/style.css" rel="stylesheet">
    <link href="../static/css/index.css" rel="stylesheet">
    <link href="../static/css/layout_wizard.css?v=101" rel="stylesheet">
</head>

<body onselectstart="return false">

    <div class="wizard-container">
        <!-- Â∑¶ÂÅ¥Ê≠•È©üÂ∞éË¶Ω -->
        <div class="step-nav">
            <div class="step-nav-title">Graph2plan</div>

            <div class="step-item active" data-step="1" onclick="goToStep(1)">
                <div class="step-number"><span>1</span></div>
                <div class="step-label">Load</div>
            </div>

            <div class="step-item disabled" data-step="2" onclick="goToStep(2)">
                <div class="step-number"><span>2</span></div>
                <div class="step-label">Search</div>
            </div>

            <div class="step-item disabled" data-step="3" onclick="goToStep(3)">
                <div class="step-number"><span>3</span></div>
                <div class="step-label">Edit & Generate</div>
            </div>

            <div class="step-item disabled" data-step="4" onclick="goToStep(4)">
                <div class="step-number"><span>4</span></div>
                <div class="step-label">Save</div>
            </div>
        </div>

        <!-- Âè≥ÂÅ¥ÂÖßÂÆπÂçÄ -->
        <div class="step-content-area">

            <!-- Step 1: Load -->
            <div class="step-content active" id="step1">
                <div class="step-content-title">Step 1: Load Floor Plan</div>
                <div class="step-content-desc">‰∏äÂÇ≥Âπ≥Èù¢ÂúñÈÇäÁïåÊ™îÊ°àÈñãÂßã</div>

                <div class="upload-zone">
                    <input type="file" id="input" onchange="wizardLoadFile(this.files)">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-text">ÈªûÊìäÊàñÊãñÊõ≥Ê™îÊ°àËá≥Ê≠§Ëôï‰∏äÂÇ≥</div>
                </div>

                <!-- Dimension Input Section -->
                <div style="margin-top: 25px; padding: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                    <div style="font-weight: 600; margin-bottom: 15px; color: #333;">ÊàñÊòØËº∏ÂÖ•Á©∫ÈñìÂ∞∫ÂØ∏Ôºö</div>
                    <div style="display: flex; gap: 10px; justify-content: center; align-items: center;">
                        <input type="number" id="roomWidth" placeholder="Èù¢ÂØ¨ (Á±≥)" step="0.1" class="form-control"
                            style="width: 120px;">
                        <span>x</span>
                        <input type="number" id="roomDepth" placeholder="Ê∑±Â∫¶ (Á±≥)" step="0.1" class="form-control"
                            style="width: 120px;">
                        <button class="btn btn-warning" onclick="wizardUseDimensions()">
                            ‰ΩøÁî®Â∞∫ÂØ∏Áî¢Áîü
                        </button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 15px; font-size: 16px; color: #666;">
                    Êàñ‰ª• <a href="javascript:void(0)" onclick="wizardLoadExample();"
                        style="color:#ff9800; text-decoration:underline; font-weight:bold; cursor:pointer;">ÁØÑ‰æã</a> ÂÅöÁÇ∫ÂèÉËÄÉ
                </div>
            </div>

            <!-- Step 2: Filter + Search + Results (Êï¥Âêà) -->
            <div class="step-content" id="step2">
                <div class="step-content-title">Step 2: Filter & Search</div>
                <div class="step-content-desc">Ë®≠ÂÆöÁØ©ÈÅ∏Ê¢ù‰ª∂‰∏¶ÊêúÂ∞ãÊ†ºÂ±Ä</div>

                <div class="step-scroll-area" style="overflow: hidden; display: flex;">
                    <div style="display: flex; gap: 20px; width: 100%; flex: 1; min-height: 0;">
                        <!-- Â∑¶ÂÅ¥ÔºöÁØ©ÈÅ∏Ê¢ù‰ª∂ (Áç®Á´ãÊç≤Âãï) -->
                        <div style="width: 320px; min-width: 320px; overflow-y: auto; padding-right: 10px;">
                            <!-- Filter Conditions ÂçÄÂ°ä -->
                            <div class="card">
                                <div class="card-title">üìã Filter Conditions</div>

                                <!-- BedRoom -->
                                <div id="BedRoomVue" style="margin-bottom:15px;">
                                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                                        <img src="../static/icon/BedRoom.png" width="18" height="18" alt="">
                                        <span id="BedRoomlb" style="font-weight:500;">BedRoom</span>
                                    </div>
                                    <el-radio-group id="BedRoom" v-model="BedRoomradio1" size="small"
                                        @change="BedRoomnum">
                                        <el-radio-button label="Any"></el-radio-button>
                                        <el-radio-button label="1+"></el-radio-button>
                                        <el-radio-button label="2+"></el-radio-button>
                                        <el-radio-button label="3+"></el-radio-button>
                                        <el-radio-button label="4+"></el-radio-button>
                                    </el-radio-group>
                                </div>

                                <!-- BathRoom -->
                                <div id="BathRoomVue" style="margin-bottom:15px;">
                                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                                        <img src="../static/icon/BathRoom.png" width="18" height="18" alt="">
                                        <span id="BathRoomlb" style="font-weight:500;">BathRoom</span>
                                    </div>
                                    <el-radio-group id="BathRoom" v-model="BathRoomradio1" size="small"
                                        @change="BathRoomnum">
                                        <el-radio-button label="Any"></el-radio-button>
                                        <el-radio-button label="1+"></el-radio-button>
                                        <el-radio-button label="2+"></el-radio-button>
                                        <el-radio-button label="3+"></el-radio-button>
                                    </el-radio-group>
                                </div>

                                <!-- Other Rooms -->
                                <div id="otherVue" style="margin-bottom:15px;">
                                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                                        <img src="../static/icon/Other.png" width="18" height="18" alt="">
                                        <span id="otherlb" style="font-weight:500;">Other Rooms</span>
                                    </div>
                                    <div style="display:flex;flex-wrap:wrap;gap:10px;font-size:13px;">
                                        <div>
                                            <span id="Kitchenlb">Kitchen:</span>
                                            <el-radio-group id="Kitchen" v-model="Kitchenradio1" size="mini"
                                                @change="Kitchennum">
                                                <el-radio-button label="Any"></el-radio-button>
                                                <el-radio-button label="1+"></el-radio-button>
                                            </el-radio-group>
                                        </div>
                                        <div>
                                            <span id="Balconylb">Balcony:</span>
                                            <el-radio-group id="Balcony" v-model="Balconyradio1" size="mini"
                                                @change="Balconynum">
                                                <el-radio-button label="Any"></el-radio-button>
                                                <el-radio-button label="1+"></el-radio-button>
                                            </el-radio-group>
                                        </div>
                                        <div>
                                            <span id="Storagelb">Storage:</span>
                                            <el-radio-group id="Storage" v-model="Storageradio1" size="mini"
                                                @change="Storagenum">
                                                <el-radio-button label="Any"></el-radio-button>
                                                <el-radio-button label="1+"></el-radio-button>
                                            </el-radio-group>
                                        </div>
                                    </div>
                                </div>

                                <!-- Detail Rooms -->
                                <div id="detailVue">
                                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                                        <img src="../static/icon/Detail.png" width="18" height="18" alt="">
                                        <span id="detailedlb" style="font-weight:500;">Bedroom Details</span>
                                    </div>
                                    <div style="display:flex;gap:15px;font-size:13px;">
                                        <div>
                                            <span id="MasterRoomlb">Master:</span>
                                            <el-radio-group id="MasterRoom" v-model="MasterRoomradio1" size="mini"
                                                @change="MasterRoomnum">
                                                <el-radio-button label="Any"></el-radio-button>
                                                <el-radio-button label="1+"></el-radio-button>
                                            </el-radio-group>
                                        </div>
                                        <div>
                                            <span id="SecondRoomlb">Second:</span>
                                            <el-radio-group id="SecondRoom" v-model="SecondRoomradio1" size="mini"
                                                @change="SecondRoomnum">
                                                <el-radio-button label="Any"></el-radio-button>
                                                <el-radio-button label="1+"></el-radio-button>
                                            </el-radio-group>
                                        </div>
                                    </div>
                                </div>

                                <!-- Number Search Button -->
                                <button class="btn btn-primary btn-lg btn-block" id="generate"
                                    onclick="wizardNumSearch()" style="width:100%;margin-top:15px;">
                                    <img src="../static/icon/Search.png" width="20" height="20" alt="">
                                    Number Search
                                </button>
                            </div>

                            <!-- LLM Graph Generation ÂçÄÂ°ä -->
                            <div class="card" style="margin-top:10px;padding:12px;">
                                <div class="card-title" style="margin-bottom:6px;font-size:14px;">üß† LLM Graph
                                    Generation
                                </div>
                                <textarea id="llmGraphPrompt" placeholder="ÊèèËø∞ÊÇ®ÊÉ≥Ë¶ÅÁöÑÊ†ºÂ±ÄÔºå‰æãÂ¶ÇÔºö‰∏âÊàøÂÖ©Ë°õ‰∏ÄÂª≥Ôºå‰∏ªËá•ÈÄ£ÈôΩÂè∞..."
                                    style="width:100%;height:160px;padding:8px;border:1px solid #ddd;border-radius:6px;resize:none;font-size:13px;line-height:1.4;box-sizing:border-box;"></textarea>

                                <!-- LLM Graph Generate Button -->
                                <button class="btn btn-primary btn-block" id="llmGraphBtn" onclick="wizardLLMGraph()"
                                    style="width:100%;margin-top:8px;padding:8px 12px;font-size:14px;">
                                    üß† Generate Graph
                                </button>
                            </div>
                        </div>

                        <!-- Âè≥ÂÅ¥ÂçÄÂüü (ÂÖ±‰∫´È´òÂ∫¶Ôºå‰∏çÊªæÂãï) -->
                        <div style="flex:1;min-width:0;display:flex;flex-direction:column;gap:15px;overflow:hidden;">
                            <!-- ‰∏äÊñπÔºöResults (Á∏ÆÂ∞èÂ§ñÊ°ÜÈ´òÂ∫¶) -->
                            <div class="results-panel" id="listbox"
                                style="width:100%;overflow:hidden;flex:0 0 300px;display:flex;flex-direction:column;">
                                <div class="results-title">Results</div>
                                <ul id="hsList" class="todo-list"
                                    style="list-style:none;padding:10px;margin:0;display:flex;flex-wrap:nowrap;gap:10px;overflow-x:scroll;flex:1;">
                                </ul>
                            </div>

                            <!-- ‰∏ãÊñπÔºöOutput Graph + Predict Layout ‰∏¶Êéí (‰ΩîÊìöÂâ©È§òÁ©∫Èñì) -->
                            <div style="display:flex;gap:20px;flex:1;min-height:0;">
                                <!-- Output Graph -->
                                <div class="graph-box" id="rightbox" style="flex:1;height:100%;">
                                    <span class="graph-box-title">Output Graph</span>
                                    <div class="placeholder-text">Ë´ãÈÅ∏Êìá‰∏äÊñπÊêúÂ∞ãÁµêÊûú</div>
                                    <svg id="RightLayoutSVG" width="220" height="220"
                                        style="position:absolute;z-index:9;top:100px;left:50%;transform:translateX(-50%);transform-origin:top center;"></svg>
                                    <svg id="RightSVG" width="220" height="220"
                                        style="position:absolute;z-index:999;top:100px;left:50%;transform:translateX(-50%);transform-origin:top center;"></svg>
                                </div>

                                <!-- Transfer Result -->
                                <div class="graph-box" id="predictbox" style="flex:1;height:100%;">
                                    <span class="graph-box-title">Transfer Result</span>
                                    <svg id="PredictLayoutSVG" width="220" height="220"
                                        style="position:absolute;z-index:9;top:100px;left:50%;transform:translateX(-50%);transform-origin:top center;"></svg>
                                    <svg id="PredictSVG" width="220" height="220"
                                        style="position:absolute;z-index:999;top:100px;left:50%;transform:translateX(-50%);transform-origin:top center;"></svg>
                                </div>
                            </div>

                            <!-- Â∫ïÈÉ®ÊåâÈàï (Âõ∫ÂÆöÊñºÂè≥ÂÅ¥ÊúÄ‰∏ãÊñπ) -->
                            <div class="next-step-btn" style="flex: 0 0 auto; text-align: right;">
                                <button class="btn btn-secondary" onclick="completeStep(2)">
                                    Continue to Edit & Generate ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Edit & Generate -->
            <div class="step-content" id="step3">
                <div class="step-content-title">Step 3: Edit & Generate</div>
                <div class="step-content-desc">Á∑®ËºØÁØÄÈªû„ÄÅÁî¢ÁîüÁµêÊûú</div>

                <div class="step-scroll-area">
                    <!-- Add Node Bar -->
                    <div id="addVue" class="add-node-bar">
                        <span style="font-weight:600;margin-right:10px;">Add Node:</span>
                        <div class="add-node-item" id="LivingRoom_a" onclick="addLivingRoom(this.id)">
                            <div class="node-dot" style="background:#c8c8c8;"></div><span>LivingRoom</span>
                        </div>
                        <div class="add-node-item" id="BedRoom_a" onclick="addLivingRoom(this.id)">
                            <div class="node-dot" style="background:#fff39a;"></div><span>Bedroom</span>
                        </div>
                        <div class="add-node-item" id="Bathroom_a" onclick="addLivingRoom(this.id)">
                            <div class="node-dot" style="background:#bfecff;"></div><span>Bathroom</span>
                        </div>
                        <div class="add-node-item" id="Balcony_a" onclick="addLivingRoom(this.id)">
                            <div class="node-dot" style="background:#d3d981;"></div><span>Balcony</span>
                        </div>
                        <div class="add-node-item" id="Kitchen_a" onclick="addLivingRoom(this.id)">
                            <div class="node-dot" style="background:#f4d7d1;"></div><span>Kitchen</span>
                        </div>
                        <div class="add-node-item" id="Storage_a" onclick="addLivingRoom(this.id)">
                            <div class="node-dot" style="background:#ffdfb6;"></div><span>Storage</span>
                        </div>
                    </div>

                    <div class="graph-area">
                        <!-- Â∑¶ÂÅ¥ÂúñÂΩ¢ -->
                        <div class="graph-box" id="leftbox">
                            <span class="graph-box-title">Input Graph</span>
                            <svg id="LeftBaseSVG" width="256" height="256"
                                style="background:#fff !important;position:absolute;z-index:1;top:60px;left:50%;transform:translateX(-50%);transform-origin:top center;"></svg>
                            <svg id="LeftLayoutSVG" width="256" height="256"
                                style="position:absolute;z-index:9;top:60px;left:50%;transform:translateX(-50%);transform-origin:top center;"></svg>
                            <svg id="LeftGraphSVG" width="256" height="256"
                                style="position:absolute;z-index:999;top:60px;left:50%;transform:translateX(-50%);transform-origin:top center;"></svg>
                        </div>
                    </div>
                </div>

                <div class="action-buttons" style="margin-top:20px; justify-content: flex-start;">
                    <button class="btn btn-success btn-lg" id="Generate">Generate</button>
                    <button class="btn btn-secondary" onclick="completeStep(3)">Continue to Save ‚Üí</button>
                </div>
            </div>

            <!-- Step 4: Save -->
            <div class="step-content" id="step4">
                <div class="step-content-title">Step 4: Save</div>
                <div class="step-content-desc">Ëº∏Âá∫ÁµêÊûúÊ™îÊ°à</div>

                <div class="card" style="text-align:center;padding:40px;">
                    <div style="font-size:48px;margin-bottom:20px;">üíæ</div>
                    <div style="font-size:18px;color:#333;margin-bottom:20px;">Ê∫ñÂÇôÂ•ΩËº∏Âá∫ÊÇ®ÁöÑÊ†ºÂ±ÄË®≠Ë®à</div>
                    <button class="btn btn-success btn-lg" id="downLoad">
                        <a style="color:#fff;text-decoration:none;">Save .mat File</a>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Âè≥ÈçµÈÅ∏ÂñÆ -->
    <div id="isDelete" style="position:absolute;display:none;z-index:99999;border:1px solid #ccc;background:#f2f2f2;">
        <ul style="margin:0;padding:0;text-align:center;list-style:none;" class="isDelete">
            <li style="padding:5px;border:1px solid #ccc;">Delete</li>
            <li style="padding:5px;border:1px solid #ccc;">Scale*0.25</li>
            <li style="padding:5px;border:1px solid #ccc;">Scale*0.5</li>
            <li style="padding:5px;border:1px solid #ccc;">Scale*2</li>
            <li style="padding:5px;border:1px solid #ccc;">Scale*5</li>
        </ul>
    </div>
    <style>
        .isDelete li:hover {
            color: #fff;
            background: #1c00ff;
        }
    </style>

    <!-- JavaScript -->
    <script src="../static/Btopenjs/jquery-2.1.3.min.js"></script>
    <script src="../static/select/vue.min.js"></script>
    <script src="../static/select/element.min.js"></script>
    <script src="../static/select/dealselect.js"></script>
    <script src="../static/select/index.js"></script>
    <script src="../static/select/index1.js"></script>
    <script src="../static/select/index2.js"></script>
    <script src="../static/select/index3.js"></script>
    <script src="../static/select/index4.js"></script>
    <script src="../static/js/d3.v5.min.js"></script>
    <script src="../static/js/graph.js"></script>
    <script>
        const SETTINGS = {
            rebound: { tension: 16, friction: 5 },
            spinner: {
                id: 'spinner', radius: 90, sides: 3, depth: 4,
                colors: { background: '#f0f0f0', stroke: '#272633', base: null, child: '#272633' },
                alwaysForward: true, restAt: 0.5, renderBase: false
            }
        };
    </script>
    <script src="../static/js/load.js"></script>
    <script src="../static/Page/js/bootstrap.min.js"></script>
    <script src="../static/js/mo.min.js"></script>
    <script src="../static/js/buttonEvent_wizard.js"></script>
    <script src="../static/js/btnEvent.js"></script>
    <script src="../static/js/wizard_wizard.js"></script>
    <script>
        function wizardUseDimensions() {
            const width = document.getElementById('roomWidth').value;
            const depth = document.getElementById('roomDepth').value;

            if (!width || !depth) {
                alert('Ë´ãËº∏ÂÖ•ÂÆåÊï¥ÁöÑÈï∑ÂØ¨Êï∏ÂÄº');
                return;
            }

            var btn = document.querySelector('.btn-warning');
            var originalText = btn.innerHTML;
            btn.innerHTML = 'ËôïÁêÜ‰∏≠...';
            btn.disabled = true;

            fetch('/index/ProcessDimensions/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    width: width,
                    depth: depth
                })
            })
                .then(response => response.json())
                .then(data => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;

                    if (data.status === 'success') {
                        console.log('Dimension processing success:', data.data);


                        var ret = data.data;
                        var hsex = ret['exterior'];
                        var doorStr = ret['door'];
                        var testName = ret['testName'];


                        // Critical for NumSearch: Set Cookie
                        document.cookie = "hsname=" + testName + "; path=/";


                        // Set Global Variables used by wizard.js/buttonEvent.js
                        if (typeof userBoundaryExterior !== 'undefined') userBoundaryExterior = hsex;
                        if (typeof userBoundaryDoor !== 'undefined') userBoundaryDoor = doorStr;


                        // Clear SVGs
                        d3.select('body').select('#LeftBaseSVG').selectAll("svg > *").remove();
                        d3.select('body').select('#LeftGraphSVG').selectAll("svg > *").remove();
                        d3.select('body').select('#LeftLayoutSVG').selectAll("svg > *").remove();
                        d3.select('body').select('#RightLayoutSVG').selectAll("svg > *").remove();
                        d3.select('body').select('#RightSVG').selectAll("svg > *").remove();

                        // Draw Exterior
                        var border = 4;
                        // Need roomcolor function, assuming it's available global (graph.js?)

                        d3.select("#LeftBaseSVG")
                            .append("polygon")
                            .attr("points", hsex)
                            .attr("fill", "none")
                            .attr("stroke", "#000") // Fallback color
                            .attr("stroke-width", border);

                        // Draw Door
                        var door = doorStr.split(",");
                        d3.select('body').select('#LeftBaseSVG').append('line')
                            .attr("x1", parseInt(door[0]))
                            .attr("y1", door[1])
                            .attr("x2", door[2])
                            .attr("y2", door[3])
                            .attr("stroke", "#F00") // Fallback color for door
                            .attr("stroke-width", border);

                        // Draw to PredictLayoutSVG
                        d3.select('body').select('#PredictLayoutSVG').selectAll('*').remove();
                        d3.select('body').select('#PredictSVG').selectAll('*').remove();
                        d3.select("#PredictLayoutSVG")
                            .append("polygon")
                            .attr("points", hsex)
                            .attr("fill", "none")
                            .attr("stroke", "#000")
                            .attr("stroke-width", border);
                        d3.select('#PredictLayoutSVG').append('line')
                            .attr("x1", parseInt(door[0]))
                            .attr("y1", door[1])
                            .attr("x2", door[2])
                            .attr("y2", door[3])
                            .attr("stroke", "#F00")
                            .attr("stroke-width", border);

                        // Transform scale (Match wizardLoadExample)
                        d3.select('body').select('#LeftBaseSVG').style("transform", "translateX(-50%) scale(1.5)");
                        d3.select('body').select('#LeftGraphSVG').style("transform", "translateX(-50%) scale(1.5)");
                        d3.select('body').select('#PredictLayoutSVG').style("transform", "translateX(-50%) scale(1.5)");
                        d3.select('body').select('#PredictSVG').style("transform", "translateX(-50%) scale(1.5)");

                        // Try calling NumSearch if available
                        if (typeof NumSearch === 'function') {
                            // NumSearch(); // Might fail if cookies or other states aren't set.
                            // For now let's just show the boundary which is the most important part.
                        }

                        // Complete Step 1
                        if (typeof completeStep === 'function') {
                            setTimeout(function () {
                                completeStep(1);
                            }, 500);
                        }

                    } else {
                        alert('ËôïÁêÜÂ§±Êïó: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    alert('ÁôºÁîüÈåØË™§');
                });
        }
    </script>

</body>

</html>